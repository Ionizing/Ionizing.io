<!doctype html>
<html lang="zh-cn">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>使用 CUDA 为 N 体模拟加速 | 伪化生搬砖工地</title>
    <meta property="og:title" content="使用 CUDA 为 N 体模拟加速 - 伪化生搬砖工地">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2020-02-06T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2020-03-02T21:04:01&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="使用 CUDA 为 N 体模拟加速">
        <meta name="author" content="[Smith Peter]">
        
    <meta property="og:url" content="https://ionizing.page/post/nbody-with-cuda/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://ionizing.page/">
                        伪化生搬砖工地
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://ionizing.page/">首页</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">使用 CUDA 为 N 体模拟加速</h1>
        </header>
        <date class="post-meta meta-date">
            2020年2月6日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='https://ionizing.page/categories/Programming'>Programming</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="简介">简介</h2>
<p>本文是研二上学期 CUDA 课程 Project 作业的简单总结。</p>
<p>在物理学中， 多体问题一般是指在已知初始位置、速度和质量的多个物体在经典力学框架下进行演化的预测问题。 在多体系统中，每个物体都受到其他物体的相互作用而使其自身的运动产生响应的影响。在天体力学中， \(N\) 体系统的模拟是典型的多体问题，物体之间的相互作用力是万有引力，每个物体受到剩余其他物体的万有引力的合力而产生加速度，进而影响自身的速度和位置。本项目即来研究天体力学中 N 体系统演化的 GPU 并行加速问题。</p>
<h2 id="环境简介">环境简介</h2>
<h3 id="硬件环境">硬件环境</h3>
<table>
<thead>
<tr>
<th>机器型号</th>
<th>ThinkPad Edge E540</th>
</tr>
</thead>
<tbody>
<tr>
<td>CPU</td>
<td>Intel Core i5 4210M 2.6GHz</td>
</tr>
<tr>
<td>RAM</td>
<td>8 GB</td>
</tr>
<tr>
<td>GPU</td>
<td>NVIDIA GT840M 2GB GRAM</td>
</tr>
</tbody>
</table>
<p>GPU 详细信息如下：</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Device name</td>
<td>GeForce 840M</td>
</tr>
<tr>
<td>totalGlobalMem</td>
<td>2048 MBytes</td>
</tr>
<tr>
<td>sharedMemPerBlock</td>
<td>49152</td>
</tr>
<tr>
<td>regsPerBlock</td>
<td>65536</td>
</tr>
<tr>
<td>warpSize</td>
<td>32</td>
</tr>
<tr>
<td>memPitch</td>
<td>2147483647</td>
</tr>
<tr>
<td>maxThreadsPerBlock</td>
<td>1024</td>
</tr>
<tr>
<td>maxThreadsDim[0 - 2]</td>
<td>1024 1024 64</td>
</tr>
<tr>
<td>totalConstMem</td>
<td>65536</td>
</tr>
<tr>
<td>major.minor</td>
<td>5.0</td>
</tr>
<tr>
<td>clockRate</td>
<td>1124000</td>
</tr>
<tr>
<td>textureAlignment</td>
<td>512</td>
</tr>
<tr>
<td>deviceOverlap</td>
<td>1</td>
</tr>
<tr>
<td>multiProcessorCount</td>
<td>3</td>
</tr>
</tbody>
</table>
<h3 id="软件环境">软件环境</h3>
<table>
<thead>
<tr>
<th>OS</th>
<th>Windows 7 64-bit</th>
</tr>
</thead>
<tbody>
<tr>
<td>CUDA</td>
<td>10.1</td>
</tr>
<tr>
<td>IDE</td>
<td>Visual Studio 2019</td>
</tr>
</tbody>
</table>
<h2 id="原型程序">原型程序</h2>
<h3 id="相关假设">相关假设</h3>
<p>本项目假设一下条件：</p>
<ul>
<li>忽略每个物体的大小，即每个物体看成质点；</li>
<li>忽略物体之间的相互碰撞；</li>
<li>每个物体的状态仅由位置 (\(q\)) 和速度 (\(\dot{q}\)) 来描述；</li>
<li>受单精度浮点数精度和时间尺度限制，万有引力常数取为 1 （正常值取为
6.67E-11）；</li>
</ul>
<h3 id="数据结构说明">数据结构说明</h3>
<p>为提高访存效率，本文使用序列化存储，即将物体状态信息的结构体展开并依次放入一维线性数组中，如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">m_position <span style="color:#000;font-weight:bold">=</span> [
        x1, y1, z1, m1,
        x2, y2, z3, m2,
        <span style="color:#000;font-weight:bold">...</span>
        <span style="color:#000;font-weight:bold">...</span>
        xn, yn, zn, mn
    ];
m_velocity <span style="color:#000;font-weight:bold">=</span> [
        vx1, vy1, vz1, <span style="color:#099">0</span>,
        vx2, vy2, vz2, <span style="color:#099">0</span>,
        <span style="color:#000;font-weight:bold">...</span>
        <span style="color:#000;font-weight:bold">...</span>
        vxn, vyn, vzn, <span style="color:#099">0</span>
        <span style="color:#000;font-weight:bold">//</span> zero <span style="color:#000;font-weight:bold">for</span> padding
    ];
</code></pre></td></tr></table>
</div>
</div><p><code>m_position</code> 中按顺序依次存放了每个物体的 <code>x</code> 、 <code>y</code> 、 <code>z</code> 和质量 <code>m</code> ，如上面代码清单中所示。 <code>m_velocity</code> 在排布数据时为了对齐和之后访问方便，在每个物体的速度变量之后多放置一个空变量，使每次访问时的偏移量都是 4 的倍数，简化访存逻辑；之后如果有需要用到所有物体加速度的数组时，它的数据结构同上。</p>
<h3 id="核心算法">核心算法</h3>
<h4 id="计算每个物体所受万有引力产生的加速度">计算每个物体所受万有引力产生的加速度</h4>
<p>每个物体受的万有引力是其他物体对其万有引力作用的合力</p>
<p>\begin{align}
a_i &amp;={} - \sum_{j\ne i} G \dfrac{m_j}{||r_{ij}||^2} \cdot \dfrac{r_{ij}}{||r_{ij}||} \\\<br>
&amp;={} \sum_{j\ne i} 1 \cdot \dfrac{m_j \cdot (q_i - q_j)}{||q_i - q_j||^3}
\end{align}</p>
<p>公式中 \(r_{ij}\) 是一个矢量，表示物体 \(j\) 到物体 \(i\) 的距离矢量，其模长即是距离的长度；由于物体间的力为引力，因此公式前面出现了负号；然而在实现这个公式过程中需要注意在分母中出现了 \(q_i - q_j\) ，我们已经假设忽略物体的形状大小和碰撞问题，那么在模拟过程中就有可能出现两个物体的距离过小使得在根据上式计算加速的过程中有零除的风险，为了解决这个问题，一个通常的做法是在计算 \(||r_{ij}||\) 时加上一个大于零的 <code>softenSqr</code> 软化因子，来避免出现零除错误。这个过程的时间复杂度是 \(\mathcal{O} (N)\) ，其中 \(N\) 是系统中物体数。</p>
<p>当已经知道如何计算每个物体的加速度，求所有物体的加速度就变得更加 trivial ，只需遍历所有的物体，重复上面的步骤即可。显然，这个过程的时间复杂度为 \(\mathcal{O} (N^2)\) ，空间复杂度为 \(\mathcal{O}(N)\) 。</p>
<p>相关代码如下:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">float3 <span style="color:#900;font-weight:bold">calcSingleAccel</span>(float4 posMassA, float4 posMassB, float3 accel) {
    float3 dr;
    dr.x <span style="color:#000;font-weight:bold">=</span> posMassA.x <span style="color:#000;font-weight:bold">-</span> posMassB.x;
    dr.y <span style="color:#000;font-weight:bold">=</span> posMassA.y <span style="color:#000;font-weight:bold">-</span> posMassB.y;
    dr.z <span style="color:#000;font-weight:bold">=</span> posMassA.z <span style="color:#000;font-weight:bold">-</span> posMassB.z;

    <span style="color:#458;font-weight:bold">float</span> mass_j   <span style="color:#000;font-weight:bold">=</span> posMassB.w;

    <span style="color:#458;font-weight:bold">float</span> distSqr  <span style="color:#000;font-weight:bold">=</span> dot(dr, dr) <span style="color:#000;font-weight:bold">+</span> softenSqr;
    <span style="color:#458;font-weight:bold">float</span> invDist  <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.0f</span> <span style="color:#000;font-weight:bold">/</span> sqrtf(distSqr);
    <span style="color:#458;font-weight:bold">float</span> invDist3 <span style="color:#000;font-weight:bold">=</span> invDist <span style="color:#000;font-weight:bold">*</span> invDist <span style="color:#000;font-weight:bold">*</span> invDist;

    <span style="color:#458;font-weight:bold">float</span> Gmdr3 <span style="color:#000;font-weight:bold">=</span> mass_j <span style="color:#000;font-weight:bold">*</span> invDist3;

    accel.x <span style="color:#000;font-weight:bold">+=</span> dr.x <span style="color:#000;font-weight:bold">*</span> Gmdr3;
    accel.y <span style="color:#000;font-weight:bold">+=</span> dr.y <span style="color:#000;font-weight:bold">*</span> Gmdr3;
    accel.z <span style="color:#000;font-weight:bold">+=</span> dr.z <span style="color:#000;font-weight:bold">*</span> Gmdr3;

    <span style="color:#000;font-weight:bold">return</span> accel;
}
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">calcTotalAccel</span>(float3 m_position[],
                    float3 m_accel[],
                    <span style="color:#000;font-weight:bold">const</span> size_t numBodies) {
    <span style="color:#000;font-weight:bold">for</span>(size_t i<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>; i<span style="color:#000;font-weight:bold">!=</span>numBodies; <span style="color:#000;font-weight:bold">++</span>i) {
        float3 accel <span style="color:#000;font-weight:bold">=</span> {<span style="color:#099">0.0f</span>, <span style="color:#099">0.0f</span>, <span style="color:#099">0.0f</span>};
        <span style="color:#000;font-weight:bold">for</span>(size_t j<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>; j<span style="color:#000;font-weight:bold">!=</span>numBodies; <span style="color:#000;font-weight:bold">++</span>j) {
            <span style="color:#000;font-weight:bold">if</span> (i <span style="color:#000;font-weight:bold">==</span> j) <span style="color:#000;font-weight:bold">continue</span>; <span style="color:#998;font-style:italic">// avoid self-interaction;
</span><span style="color:#998;font-style:italic"></span>            accel <span style="color:#000;font-weight:bold">=</span> calcSingleAccel(m_position[i],
                                    m_position[j],
                                    accel);
        }
        m_accel[i] <span style="color:#000;font-weight:bold">=</span> accel;
    }
}
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<h4 id="对每个物体的状态进行演化">对每个物体的状态进行演化</h4>
<p>已知每个物体的加速度，那么每个物体的状态演化过程满足</p>
<p>\begin{align}
v_i &amp;={} \int_{t_0}^{t_1} a_i dt \\\<br>
q_i &amp;={} \int_{t_0}^{t_1} v_i dt
\end{align}</p>
<p>显然，我们需要先对 \(v_i\) 进行演化，每个时间间隔内 \(v_i\) 的增量为加速度和时间间隔的乘积 \(a_i \cdot dt\) 。由于忽略了物体形状大小和碰撞，系统的机械能守恒，在模拟中为了模拟机械能损耗，在对速度演化后，使它经历一个阻尼过程，即演化后的速度乘以一个阻尼因子 <code>damp</code> ，本文中 <code>damp</code> 统一取为 <code>0.95</code> 。</p>
<p>相关代码如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">propergate</span>(float4 m_position[],
                float3 m_velocity[],
                float3 m_accel[],
                <span style="color:#000;font-weight:bold">const</span> size_t numBodies,
                <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span>  deltaT) {

    calcTotalAccel(m_position, m_accel, numBodies);
    <span style="color:#000;font-weight:bold">for</span> (size_t i<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>; i<span style="color:#000;font-weight:bold">!=</span>numBodies; <span style="color:#000;font-weight:bold">++</span>i) {
        float3 vel <span style="color:#000;font-weight:bold">=</span> m_velocity[i];
        float3 acc <span style="color:#000;font-weight:bold">=</span> m_accel[i];
        float4 pos <span style="color:#000;font-weight:bold">=</span> m_position[i];

        vel.x <span style="color:#000;font-weight:bold">+=</span> acc.x <span style="color:#000;font-weight:bold">*</span> deltaT;
        vel.y <span style="color:#000;font-weight:bold">+=</span> acc.y <span style="color:#000;font-weight:bold">*</span> deltaT;
        vel.z <span style="color:#000;font-weight:bold">+=</span> acc.z <span style="color:#000;font-weight:bold">*</span> deltaT;

        vel.x <span style="color:#000;font-weight:bold">*=</span> damp;
        vel.y <span style="color:#000;font-weight:bold">*=</span> damp;
        vel.z <span style="color:#000;font-weight:bold">*=</span> damp;

        pos.x <span style="color:#000;font-weight:bold">+=</span> vel.x <span style="color:#000;font-weight:bold">*</span> deltaT;
        pos.y <span style="color:#000;font-weight:bold">+=</span> vel.y <span style="color:#000;font-weight:bold">*</span> deltaT;
        pos.z <span style="color:#000;font-weight:bold">+=</span> vel.z <span style="color:#000;font-weight:bold">*</span> deltaT;

        m_position[i] <span style="color:#000;font-weight:bold">=</span> pos;
        m_velocity[i] <span style="color:#000;font-weight:bold">=</span> vel;
    }
}
</code></pre></td></tr></table>
</div>
</div><p>总体而言，这个算法的时间复杂度为 \(\mathcal{O}(N^2)\) ，空间复杂度为
\(\mathcal{O}(N)\) 。</p>
<h3 id="运行结果">运行结果</h3>
<p>为方便评估运行性能，本文统一使用 Release 版本程序，让程序演化 512 步（若每一步演化的时间过长，可减少演化总步数来节省评估时间），计算出每秒演化的步数 （FPS） ，通过比较 FPS 来反映程序的运行效率。</p>
<table>
<thead>
<tr>
<th>numBodies</th>
<th>FPS</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>1523.8</td>
</tr>
<tr>
<td>512</td>
<td>321.0</td>
</tr>
<tr>
<td>1024</td>
<td>89.6</td>
</tr>
<tr>
<td>2048</td>
<td>21.9</td>
</tr>
<tr>
<td>4096</td>
<td>5.56</td>
</tr>
<tr>
<td>8192</td>
<td>1.4</td>
</tr>
</tbody>
</table>
<p>当物体数量 \(N\) 多于 2^13 = 8192 时， CPU 版本的程序每一步运行时间过长，因此不再继续测试。</p>
<figure>
    <img src="./cpu.png"/> 
</figure>

<p>从图中可以明显看出，串行版本程序的运行效率是二次方递减的（斜率为 2 ），这相当符合 \(\mathcal{O}(N^2)\) 的时间复杂度特征。</p>
<h2 id="优化过程">优化过程</h2>
<p>在上一节中本文已经实现了串行版本的 N 体问题模拟程序，因其具有
\(\mathcal{O}(N^2)\) 的时间复杂度，当模拟物体的数量增加时，计算演化所需的时间呈二次方增加，这个增长速度显然不能使我们满意。</p>
<h3 id="优化思路">优化思路</h3>
<p>分析上一节中串行版本程序，可以发现性能热点集中于计算所有物体的加速度上，并且它的计算有以下特点：</p>
<ul>
<li>在同一时刻，计算每个物体的加速度仅与上一时刻所有物体的位置有关，与其他物体的速度无关；</li>
<li>在同一时刻，计算每个物体的加速度并不会改变其他任何变量；</li>
<li>在同一时刻，计算物体所受合力并不影响其他物体合力的计算。</li>
</ul>
<p>这三个特点，尤其是最后一个特点可以让我们很自然地联想到用并行方法处理每个物体的加速度，由于计算单个物体的加速度并不影响计算其他物体的加速度，就有了第一种优化方法。</p>
<h4 id="线程并行加速">线程并行加速</h4>
<p>本文为每个物体分配一个线程，每个线程仅涉及读取所有物体的位置信息，而在写入加速信息时只写入该物体的加速度信息，因此不存在竞争，这使得此过程可以很轻松地被并行化，从而利用空间换时间，使时间复杂度从 \(\mathcal{O}(N^2)\) 降到 \(\mathcal{O}(N)\)
，而空间复杂度维持在 \(\mathcal{O}(N)\) 。</p>
<p>对于每个物体状态进行演化的并行化更简单：</p>
<ul>
<li>每个物体的状态演化仅受其自身加速的和自身速度影响。</li>
</ul>
<p>因此在演化系统状态时，我们为每个物体分配一个线程，这个线程只涉及读取物体的加速度、速度和位置，只对该物体的速度和位置变量进行写入，因此不存在数据竞争现象。</p>
<p>需要注意的是，由于每个线程计算加速度的耗时可能并不相同，因此我们需要在状态演化完成后对所有线程进行同步，避免有的线程过快地读取到未演化完成的其他物体的额位置信息。</p>
<p>有了以上思路，优化后的线程并行代码很容易得到：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">propergateSingleGPU</span>(<span style="color:#458;font-weight:bold">float</span><span style="color:#000;font-weight:bold">*</span> posMass,
                                    <span style="color:#458;font-weight:bold">float</span><span style="color:#000;font-weight:bold">*</span> vels,
                                    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> deltaT,
                                    <span style="color:#000;font-weight:bold">const</span> size_t numBodies) {
    size_t ithread <span style="color:#000;font-weight:bold">=</span> threadIdx.x <span style="color:#000;font-weight:bold">+</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockIdx.x;
    <span style="color:#000;font-weight:bold">const</span> size_t ibody <span style="color:#000;font-weight:bold">=</span> ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span>;

    <span style="color:#000;font-weight:bold">if</span> (ithread <span style="color:#000;font-weight:bold">&lt;</span> numBodies) {
    float3 F <span style="color:#000;font-weight:bold">=</span> { <span style="color:#099">0.0f</span>, <span style="color:#099">0.0f</span>, <span style="color:#099">0.0f</span> };
    <span style="color:#000;font-weight:bold">for</span> (size_t j <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; j <span style="color:#000;font-weight:bold">!=</span> numBodies; <span style="color:#000;font-weight:bold">++</span>j) {
        <span style="color:#000;font-weight:bold">const</span> size_t jbody <span style="color:#000;font-weight:bold">=</span> j <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span>;
        float3 dr;
        dr.x <span style="color:#000;font-weight:bold">=</span> posMass[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">-</span> posMass[jbody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>];
        dr.y <span style="color:#000;font-weight:bold">=</span> posMass[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">-</span> posMass[jbody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>];
        dr.z <span style="color:#000;font-weight:bold">=</span> posMass[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>] <span style="color:#000;font-weight:bold">-</span> posMass[jbody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>];
<span style="color:#999;font-weight:bold;font-style:italic">#define dot(a, b) (a.x * b.x + a.y * b.y + a.z * b.z)
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>        <span style="color:#458;font-weight:bold">float</span> distSqr <span style="color:#000;font-weight:bold">=</span> dot(dr, dr) <span style="color:#000;font-weight:bold">+</span> softenSqr;
<span style="color:#999;font-weight:bold;font-style:italic">#undef dot
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>        <span style="color:#458;font-weight:bold">float</span> invDist <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.0f</span> <span style="color:#000;font-weight:bold">/</span> sqrtf(distSqr);
        <span style="color:#458;font-weight:bold">float</span> invDist3 <span style="color:#000;font-weight:bold">=</span> invDist <span style="color:#000;font-weight:bold">*</span> invDist <span style="color:#000;font-weight:bold">*</span> invDist;

        F.x <span style="color:#000;font-weight:bold">+=</span> dr.x <span style="color:#000;font-weight:bold">*</span> invDist3 <span style="color:#000;font-weight:bold">*</span> posMass[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">3</span>];
        F.y <span style="color:#000;font-weight:bold">+=</span> dr.y <span style="color:#000;font-weight:bold">*</span> invDist3 <span style="color:#000;font-weight:bold">*</span> posMass[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">3</span>];
        F.z <span style="color:#000;font-weight:bold">+=</span> dr.z <span style="color:#000;font-weight:bold">*</span> invDist3 <span style="color:#000;font-weight:bold">*</span> posMass[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">3</span>];
    }
    vels[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">+=</span> deltaT <span style="color:#000;font-weight:bold">*</span> F.x; vels[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">*=</span> damp; <span style="color:#998;font-style:italic">// evolve velocity here
</span><span style="color:#998;font-style:italic"></span>    vels[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">+=</span> deltaT <span style="color:#000;font-weight:bold">*</span> F.y; vels[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">*=</span> damp;
    vels[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>] <span style="color:#000;font-weight:bold">+=</span> deltaT <span style="color:#000;font-weight:bold">*</span> F.z; vels[ibody <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>] <span style="color:#000;font-weight:bold">*=</span> damp;
    }
}
</code></pre></td></tr></table>
</div>
</div><p>这里笔者将加速度与速度的演化合并在同一个函数中，避免了单独分配一个储存加速度的数组，节省了空间；同时也避免了对加速度的写入和读取，节省了时间。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">integratePositionGPU</span>(<span style="color:#458;font-weight:bold">float</span><span style="color:#000;font-weight:bold">*</span> posMass,
                                     <span style="color:#458;font-weight:bold">float</span><span style="color:#000;font-weight:bold">*</span> vels,
                                     <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> deltaT,
                                     <span style="color:#000;font-weight:bold">const</span> size_t numBodies) {
    <span style="color:#000;font-weight:bold">const</span> size_t ithread <span style="color:#000;font-weight:bold">=</span> threadIdx.x <span style="color:#000;font-weight:bold">+</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockIdx.x;
    <span style="color:#000;font-weight:bold">if</span> (ithread <span style="color:#000;font-weight:bold">&lt;</span> numBodies) {
        posMass[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">+=</span> vels[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">*</span> deltaT;
        posMass[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">+=</span> vels[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">*</span> deltaT;
        posMass[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>] <span style="color:#000;font-weight:bold">+=</span> vels[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>] <span style="color:#000;font-weight:bold">*</span> deltaT;
    }
}
</code></pre></td></tr></table>
</div>
</div><h5 id="正确性验证">正确性验证</h5>
<p>通过在主函数中设置断点，并将 GPU 上演化后的物体状态信息传回内存，与之前 CPU 串行版本程序的结果进行比较，发现两者完全一致，因此这个程序的正确性是可以得到保证。对比截图如下：</p>
<figure>
    <img src="./GPUparallel_correctness.png"/> 
</figure>

<h5 id="运行结果">运行结果</h5>
<ul>
<li>固定 <code>numBodies = 1 &lt;&lt; 14</code> ，对每个块分到的线程数 <code>threadsPerBlock</code> 进行扫描</li>
</ul>
<table>
<thead>
<tr>
<th>threadsPerBlock</th>
<th>FPS</th>
</tr>
</thead>
<tbody>
<tr>
<td>8</td>
<td>6.2</td>
</tr>
<tr>
<td>16</td>
<td>12.3</td>
</tr>
<tr>
<td>32</td>
<td>22.9</td>
</tr>
<tr>
<td>64</td>
<td>25.8</td>
</tr>
<tr>
<td>128</td>
<td>25.8</td>
</tr>
<tr>
<td>256</td>
<td>25.4</td>
</tr>
<tr>
<td>512</td>
<td>25.1</td>
</tr>
<tr>
<td>1024</td>
<td>23.3</td>
</tr>
</tbody>
</table>
<figure>
    <img src="./gpu_para_tpb.png"/> 
</figure>

<p>从上图中，我们可以很明显看出，当 <code>threadsPerBlock = 64</code> 时能最大化发挥 GPU 每个块的计算能力，尽管在 <code>deviceInfo</code> 中每个块最多可以分配 <code>1024</code> 个线程，但每个块的寄存器数量是固定的，因此当对块分配过多线程，每个线程分配到的寄存器数量会降低，反而影响运算效率。</p>
<ul>
<li>固定 <code>threadsPerBlock = 64</code> ，对模拟物体数量 <code>numBodies</code> 进行扫描，由于在
<code>numBodies</code> 取值较小时运行时间较短，本文倾向于计时准确性存疑，故此处数据仅供参考</li>
</ul>
<table>
<thead>
<tr>
<th>numBodies</th>
<th>FPS</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>3210.0</td>
</tr>
<tr>
<td>512</td>
<td>2419.0</td>
</tr>
<tr>
<td>1024</td>
<td>1729.6</td>
</tr>
<tr>
<td>2048</td>
<td>946.9</td>
</tr>
<tr>
<td>4096</td>
<td>375.3</td>
</tr>
<tr>
<td>8192</td>
<td>94.9</td>
</tr>
<tr>
<td>12800</td>
<td>39.1</td>
</tr>
<tr>
<td>16384</td>
<td>25.8</td>
</tr>
<tr>
<td>25600</td>
<td>10.44</td>
</tr>
<tr>
<td>32876</td>
<td>6.6</td>
</tr>
</tbody>
</table>
<figure>
    <img src="./gpu_para_nb.png"/> 
</figure>

<p>从 <code>numBodies = 4096</code> 开始， FPS 的变化趋势已经大致和模拟物体数量呈负二次方速率递减，故可以认为当模拟物体数量 <code>numBodies</code> 为 4096 时，本机的显卡已经最大化发挥了它的性能（在当前算法优化程度和编译参数下）。对比串行版本模拟 8192 个物体只有
1.4 FPS 的效率，线程并行加速后的程序模拟 8192 个物体的效率能达到 94.9 FPS ，加速比达到 67.8 ，效率陡然提升了近两个数量级，由此可见本项目 N 体模拟是一个十分适合并行加速的问题，且不需要过多修改代码就能带来相当大的性能收益。</p>
<figure>
    <img src="./GPUparallel_benchmark.png"/> 
</figure>

<h4 id="块内共享显存辅助的线程并行加速">块内共享显存辅助的线程并行加速</h4>
<p>在图形显示卡中，可以存放数据的存储器有流处理器的缓存、块内的共享显存和显存，它们的访问效率依次降低，考虑到流处理器的缓存过小，且无法人为精确控制对它的读写行为（由编译器决定），而显存虽空间足够大，但访问效率不高，因此考虑利用块内的共享显存尝试实现进一步的加速效果。</p>
<p>在上节中，计算量最大的部分是计算每个物体的加速度，这个过程实质上是在计算一个相互作用矩阵 \(A\) ，矩阵元 \(A_{ij}\) 表示第 \(i\) 个物体与第 \(j\) 个物体的万有引力作用，求每个物体受到的合力时对 \(A\) 每行或每列求和即可，由此我们可以想到将
\(A\) 进行分块：</p>
<ul>
<li>将所有物体分为多个 <code>tile</code> ，每个 <code>tile</code> 含有 <code>tileSize</code> 个物体，每个物体分配一个线程；</li>
<li>每个 <code>tile</code> 使用共享显存，这段共享显存储存了这个 <code>tile</code> 内物体的位置信息；</li>
<li>在计算加速度前需要对块内的线程进行同步，确保块内的线程都已经把各自的位置信息写入了这块共享内存；</li>
<li>计算二体相互作用的过程与之间的算法没有本质区别；</li>
<li>在对该 <code>tile</code> 计算完成后需要再次对块内的线程进程同步，确保下次各个线程写入位置到共享内存时不会存在竞争现象；</li>
<li>分块计算时每个线程并不能立即得到其计算物体的最终加速度（需要其他块内的计算结果），因此需要分配一个全局的显存负责暂存每个物体加速度的中间值，每个 <code>tile</code> 计算完成后将所得加速度的值累加到这个全局数组上；</li>
<li>最后当所有 <code>tile</code> 都计算完成时需要对显卡设备上所有的线程进行全局同步（在主函数内完成），确保不会出现数据竞争现象。</li>
</ul>
<p>笔者使用的显卡每个块具有共享内存 48 KB ，最多可以分配
<code>49152 / 4 / sizeof(float) = 1536</code> 个物体，然而每个块最多可以分配 <code>1024</code> 个线程，故在调用时仅考虑每个块分配的线程数即可。</p>
<p>修改后的代码如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">__device__ <span style="color:#458;font-weight:bold">void</span>
<span style="color:#900;font-weight:bold">tileCalAccsGPU</span>(<span style="color:#458;font-weight:bold">float</span> mPos_i[<span style="color:#099">4</span>],
               <span style="color:#458;font-weight:bold">float</span>  accel[<span style="color:#099">4</span>]) {
    <span style="color:#000;font-weight:bold">extern</span> __shared__ <span style="color:#458;font-weight:bold">float</span> sh_mPos[];
    <span style="color:#000;font-weight:bold">for</span> (size_t i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> blockDim.x; <span style="color:#000;font-weight:bold">++</span>i) {
        calcSingleAccGPU(mPos_i, <span style="color:#000;font-weight:bold">&amp;</span>sh_mPos[<span style="color:#099">4</span> <span style="color:#000;font-weight:bold">*</span> i], accel);
    }
}
</code></pre></td></tr></table>
</div>
</div><p>由于在调用这个函数前各个线程已经把自身对应的 <code>mPos</code> 写入了 <code>sh_mPos</code> 内，此处对 <code>sh_mPos</code> 遍历不会产生无效访问。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">__global__ <span style="color:#458;font-weight:bold">void</span>
<span style="color:#900;font-weight:bold">calcTotAccsGPU</span>(<span style="color:#458;font-weight:bold">float</span><span style="color:#000;font-weight:bold">*</span> mPos,
               <span style="color:#458;font-weight:bold">float</span><span style="color:#000;font-weight:bold">*</span> mAcc,
               <span style="color:#000;font-weight:bold">const</span> size_t numBodies,
               <span style="color:#000;font-weight:bold">const</span> size_t tileSize) {

    <span style="color:#000;font-weight:bold">extern</span> __shared__ <span style="color:#458;font-weight:bold">float</span> sh_mPos[];
    <span style="color:#458;font-weight:bold">float</span> myPos[<span style="color:#099">4</span>];
    <span style="color:#458;font-weight:bold">float</span> accel[<span style="color:#099">4</span>] <span style="color:#000;font-weight:bold">=</span> { <span style="color:#099">0.0f</span>, <span style="color:#099">0.0f</span>, <span style="color:#099">0.0f</span>, <span style="color:#099">0.0f</span> };
    size_t ibody <span style="color:#000;font-weight:bold">=</span> threadIdx.x <span style="color:#000;font-weight:bold">+</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockIdx.x;

    myPos[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">=</span> mPos[ibody <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>];
    myPos[<span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">=</span> mPos[ibody <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>];
    myPos[<span style="color:#099">2</span>] <span style="color:#000;font-weight:bold">=</span> mPos[ibody <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>];
    myPos[<span style="color:#099">3</span>] <span style="color:#000;font-weight:bold">=</span> mPos[ibody <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">3</span>];

    <span style="color:#000;font-weight:bold">for</span> (size_t i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, tile <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> numBodies; i <span style="color:#000;font-weight:bold">+=</span> tileSize, <span style="color:#000;font-weight:bold">++</span>tile) {
        <span style="color:#000;font-weight:bold">const</span> size_t idx <span style="color:#000;font-weight:bold">=</span> tile <span style="color:#000;font-weight:bold">*</span> blockDim.x <span style="color:#000;font-weight:bold">+</span> threadIdx.x;
        <span style="color:#000;font-weight:bold">const</span> size_t ithread <span style="color:#000;font-weight:bold">=</span> threadIdx.x;

        sh_mPos[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">=</span> mPos[idx <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>];
        sh_mPos[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">=</span> mPos[idx <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>];
        sh_mPos[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>] <span style="color:#000;font-weight:bold">=</span> mPos[idx <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>];
        sh_mPos[ithread <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">3</span>] <span style="color:#000;font-weight:bold">=</span> mPos[idx <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">3</span>];

        __syncthreads();
        tileCalAccsGPU(myPos, accel);
        __syncthreads();
    }

    <span style="color:#998;font-style:italic">// apply acceleration results
</span><span style="color:#998;font-style:italic"></span>    mAcc[ibody <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">=</span> accel[<span style="color:#099">0</span>];
    mAcc[ibody <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">=</span> accel[<span style="color:#099">1</span>];
    mAcc[ibody <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>] <span style="color:#000;font-weight:bold">=</span> accel[<span style="color:#099">2</span>];
}
</code></pre></td></tr></table>
</div>
</div><p>上面代码中两处 <code>__syncthreads()</code> 即对应了块内线程同步的时刻，保证每个线程在写入
<code>sh_mPos</code> 时和在计算加速度过程中读取 <code>sh_mPos</code> 时不会存在数据竞争。</p>
<h5 id="运行结果">运行结果</h5>
<p>在正确性方面，同样使用设置断点和与 CPU 串行版本比较结果的方法来进行验证，验证结果表明该方法与 CPU 版本结果一致。</p>
<figure>
    <img src="./GPUdynShMem_correctness.png"/> 
</figure>

<p>该测试依旧固定 <code>numBodies = 16384</code> ，对每个块分到的线程数进行扫描，得到结果如下：</p>
<table>
<thead>
<tr>
<th>tileSize</th>
<th>FPS</th>
</tr>
</thead>
<tbody>
<tr>
<td>8</td>
<td>5.74</td>
</tr>
<tr>
<td>16</td>
<td>12.51</td>
</tr>
<tr>
<td>32</td>
<td>25.19</td>
</tr>
<tr>
<td>64</td>
<td>25.77</td>
</tr>
<tr>
<td>128</td>
<td>26.26</td>
</tr>
<tr>
<td>256</td>
<td>26.38</td>
</tr>
<tr>
<td>512</td>
<td>26.25</td>
</tr>
<tr>
<td>1024</td>
<td>23.56</td>
</tr>
</tbody>
</table>
<figure>
    <img src="./gpu_dsm_ts.png"/> 
</figure>

<p>固定 <code>tileSize = 256</code>, 扫描 <code>numBodies</code> ，结果如下：</p>
<table>
<thead>
<tr>
<th>numBodies</th>
<th>FPS</th>
</tr>
</thead>
<tbody>
<tr>
<td>512</td>
<td>2790.19</td>
</tr>
<tr>
<td>1024</td>
<td>2140.02</td>
</tr>
<tr>
<td>2048</td>
<td>1145.73</td>
</tr>
<tr>
<td>4096</td>
<td>315.47</td>
</tr>
<tr>
<td>8192</td>
<td>96.20</td>
</tr>
<tr>
<td>12800</td>
<td>42.80</td>
</tr>
<tr>
<td>16384</td>
<td>26.34</td>
</tr>
<tr>
<td>25600</td>
<td>11.17</td>
</tr>
<tr>
<td>32768</td>
<td>6.87</td>
</tr>
</tbody>
</table>
<figure>
    <img src="./gpu_dsm_nb.png"/> 
</figure>

<p>对比使用线程并行的版本，使用共享显存加速的程序在达到显卡负载峰值后对计算效率的提升十分有限——仅有个位数的帧数提升。</p>
<figure>
    <img src="./GPUdynShMem_benchmark.png"/> 
</figure>

<h2 id="结果总结">结果总结</h2>
<p>本项目以 N 体模拟为题探究了 CUDA 对其的加速效果，通过实验发现，线程并行对这个问题有巨大的性能提升，加速比可达 67.8 ，且 N 体中的 N 越大， CUDA 加速效果越明显。在使用线程并行加速的基础上，本人还试图使用共享显存进一步加速，但结果表明这一尝试并未获得期望的性能提升，本人倾向于是因为笔者太菜，没有组织好相关代码，未能充分发挥显卡的性能。</p>
<h3 id="一点私货">一点私货</h3>
<p>除了上面提到的算法方面的优化，还有其他的优化方法：</p>
<ol>
<li>在编译选项中加入 <code>--use_fast_math</code> ，可以试线程并行版本的程序运行效率直接 x2
，对使用共享显存的线程并行程序加速效果反而没那么夸张，运行效率只能 x1.6 左右；</li>
<li>对访存进行优化，比如把需要频繁访问的数据放在栈上进行访问，而不是频繁从堆中访问；</li>
<li>使用只读数据缓存，；</li>
<li>切换计算能力；</li>
<li>当有信心保证指针所指的空间不存在重叠时，对只读参数使用 <code>const float* __restrict__</code>
参数；</li>
<li>编译优化层级选择 <code>-O3</code> ，在不改变代码的情况下最大程度榨取显卡性能。</li>
</ol>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://ionizing.page/">Ionizing</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://ionizing.page/post/nbody-with-cuda/">https://ionizing.page/post/nbody-with-cuda/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='https://ionizing.page/tags/NBody'>NBody</a></li>
                
                <li><a href='https://ionizing.page/tags/C&#43;&#43;'>C&#43;&#43;</a></li>
                
                <li><a href='https://ionizing.page/tags/CUDA'>CUDA</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "Ionizing/ionizing.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://ionizing.page/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://ionizing.page/post/nbody-with-cuda/" title="使用 CUDA 为 N 体模拟加速">使用 CUDA 为 N 体模拟加速</a>
    </li>
    
    <li>
        <a href="https://ionizing.page/post/compile-vasp-on-macos/" title="在 macOS 上编译 VASP 5.4.4">在 macOS 上编译 VASP 5.4.4</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="https://ionizing.page/categories/Programming/">Programming (1)</a></li>
    
    <li><a href="https://ionizing.page/categories/VASP/">VASP (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="https://ionizing.page/tags/C&#43;&#43;/">C&#43;&#43;</a>
    
    <a href="https://ionizing.page/tags/CUDA/">CUDA</a>
    
    <a href="https://ionizing.page/tags/NBody/">NBody</a>
    
    <a href="https://ionizing.page/tags/VASP/">VASP</a>
    
    <a href="https://ionizing.page/tags/macOS/">macOS</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://ionizing.page/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="https://ionizing.page/">伪化生搬砖工地 By Ionizing</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.2.8/raphael.min.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/flowchart/1.12.2/flowchart.min.js" crossorigin="anonymous"></script>
        <script>(function () {
                if (!window.flowchart) return;
                const blocks = document.querySelectorAll('pre code.language-flowchart, pre code.language-flow');
                for (let i = 0; i < blocks.length; i++) {
                    const block = blocks[i];
                    const rootElement = block.parentNode;
                    const container = document.createElement('div');
                    const id = `js-flowchart-diagrams-${i}`;
                    container.id = id;
                    container.className = 'align-center';
                    container.setAttribute("style", "overFlow-x:auto");
                    rootElement.parentNode.replaceChild(container, rootElement);
                    const diagram = flowchart.parse(block.childNodes[0].nodeValue);
                    diagram.drawSVG(id, window.flowchartDiagramsOptions ? window.flowchartDiagramsOptions : {});
                }
            })();
        </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js" crossorigin="anonymous"></script>
        <script>window.sequenceDiagramsOptions = {theme: 'simple'};(function () {
            if (!window.Diagram) return;
            const blocks = document.querySelectorAll('pre code.language-sequence');
            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                
                const rootElement = block.parentNode;
                const container = document.createElement('div');
                const id = `js-sequence-diag-${i}`;
                container.id = id;
                container.className = 'align-center';
                container.setAttribute("style", "overFlow-x:auto");
                rootElement.parentNode.replaceChild(container, rootElement);

                const diagram = Diagram.parse(block.childNodes[0].nodeValue);
                diagram.drawSVG(id, window.sequenceDiagramsOptions
                    ? window.sequenceDiagramsOptions
                    : { theme: 'simple' });
            }
        })();
        </script><script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-101595379-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>